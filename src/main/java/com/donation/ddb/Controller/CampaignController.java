package com.donation.ddb.Controller;

import com.donation.ddb.Converter.CampaignCommentLikeConverter;
import com.donation.ddb.Converter.CampaignConverter;
import com.donation.ddb.Converter.CampaignUpdateConverter;
import com.donation.ddb.Domain.*;
import com.donation.ddb.Domain.Enums.CampaignStatusFlag;
import com.donation.ddb.Dto.Request.*;
import com.donation.ddb.Dto.Response.CampaignResponse;
import com.donation.ddb.Dto.Response.OrganizationResponse;
import com.donation.ddb.ImageStore;
import com.donation.ddb.Repository.NotificationRepository;
import com.donation.ddb.Repository.projection.CampaignWithUpdate;
import com.donation.ddb.Service.CampaignCommentLikeService.CampaignCommentLikeService;
import com.donation.ddb.Service.CampaignCommentService.CampaignCommentCommandService;
import com.donation.ddb.Service.CampaignCommentService.CampaignCommentQueryService;
import com.donation.ddb.Service.CampaignPlansService.CampaignPlanCommandService;
import com.donation.ddb.Service.CampaignPlansService.CampaignPlansQueryService;
import com.donation.ddb.Service.CampaignService.CampaignCommandService;
import com.donation.ddb.Service.CampaignService.CampaignQueryService;
import com.donation.ddb.Service.CampaignSpendingService.CampaignSpendingCommandService;
import com.donation.ddb.Service.CampaignSpendingService.CampaignSpendingQueryService;
import com.donation.ddb.Service.CampaignUpdateService.CampaignUpdateCommandService;
import com.donation.ddb.Service.DonationService.DonationService;
import com.donation.ddb.Service.NotificationService;
import com.donation.ddb.Service.OrganizationUserService.OrganizationUserQueryService;
import com.donation.ddb.apiPayload.ApiResponse;
import com.donation.ddb.apiPayload.code.status.ErrorStatus;
import com.donation.ddb.apiPayload.exception.handler.CampaignHandler;
import com.donation.ddb.validation.ExistCampaign;
import jakarta.validation.Valid;
import lombok.NoArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.math.BigDecimal;
import java.util.List;
import java.util.Map;

@RestController
@NoArgsConstructor
@RequestMapping("/api/v1/campaigns")
@Slf4j
@Validated
public class CampaignController {
    @Autowired
    private CampaignQueryService campaignQueryService;

    @Autowired
    private CampaignCommandService campaignCommandService;

    @Autowired
    private OrganizationUserQueryService organizationUserQueryService;

    @Autowired
    private CampaignPlansQueryService campaignPlansQueryService;

    @Autowired
    private CampaignSpendingQueryService campaignSpendingQueryService;

    @Autowired
    private CampaignCommentQueryService campaignCommentQueryService;

    @Autowired
    private CampaignCommentCommandService campaignCommentCommandService;

    @Autowired
    private CampaignCommentLikeService campaignCommentLikeService;
    @Autowired
    private CampaignPlanCommandService campaignPlanCommandService;
    @Autowired
    private CampaignUpdateCommandService campaignUpdateCommandService;
    @Autowired
    private CampaignSpendingCommandService campaignSpendingCommandService;

    @Autowired
    private DonationService donationService;

    @Autowired
    private NotificationService notificationService;

    @GetMapping("home")
    public ApiResponse<?> campaignList() {
        List<CampaignResponse.CampaignListDto> popular = campaignQueryService.findAllCampaigns(
                null,
                null,
                "FUNDRAISING",
                "POPULAR",
                3
        );
        List<CampaignResponse.CampaignListDto> latest = campaignQueryService.findAllCampaigns(
                null,
                null,
                "FUNDRAISING",
                "LATEST",
                3
        );
        List<CampaignResponse.CampaignListDto> endingSoon = campaignQueryService.findAllCampaigns(
                null,
                null,
                "FUNDRAISING",
                "ENDING_SOON",
                3
        );
        List<CampaignWithUpdate> recentUpdates = campaignQueryService.findRecentUpdates();

//         üî• Ï¥ù Í∏∞Î∂ÄÍ∏à Ï°∞Ìöå Ï∂îÍ∞Ä
        BigDecimal totalDonation = donationService.findAllAmount();

        Map<String, Object> campaignResponseDtoList = Map.of(
                "popular", popular,
                "latest", latest,
                "endingSoon", endingSoon,
                "recentUpdates", CampaignConverter.toRecentUpdateListDto(recentUpdates),
                "totalDonation", totalDonation  // üî• Ï¥ù Í∏∞Î∂ÄÍ∏à Ï∂îÍ∞Ä
        );
        return ApiResponse.onSuccess(campaignResponseDtoList);
    }

    // ÏßÑÌñâ Ï§ë Ï∫†ÌéòÏù∏ Î¶¨Ïä§Ìä∏
    @GetMapping("fundraising")
    public ResponseEntity<?> inProgressCampaignList(
            @RequestParam(value = "category", required = false) String category,
            @RequestParam(value = "sortType", required = false) String sortType
    ) {

        List<CampaignResponse.CampaignListDto> campaignResponseDtoList = campaignQueryService.findAllCampaigns(
                null,
                category,
                "FUNDRAISING",
                sortType,
                null
        );

        Map<String, Object> resMap = Map.of(
                "campaigns", campaignResponseDtoList,
                "totalElements", campaignResponseDtoList.size()
        );

        return ResponseEntity.ok(resMap);
    }

    // ÏôÑÎ£åÎêú Ï∫†ÌéòÏù∏ Î¶¨Ïä§Ìä∏
    @GetMapping("completed")
    public ResponseEntity<?> endedCampaignList(
            @RequestParam(value = "category", required = false) String category,
            @RequestParam(value = "sortType", required = false) String sortType
    ) {

        List<CampaignResponse.CampaignListDto> campaignResponseDtoList = campaignQueryService.findAllCampaigns(
                null,
                category,
                "COMPLETED",
                sortType,
                null
        );

        Map<String, Object> resMap = Map.of(
                "campaigns", campaignResponseDtoList,
                "totalElements", campaignResponseDtoList.size()
        );

        return ResponseEntity.ok(resMap);
    }

    // Í≤ÄÏÉâ
    @GetMapping("search")
    public ResponseEntity<?> campaignList(
            @RequestParam(value = "category", required = false) String category,
            @RequestParam(value = "keyword", required = false) String keyword,
            @RequestParam(value = "statusFlag", required = false) String statusFlag,
            @RequestParam(value = "sortType", required = false) String sortType
    ) {
        // CampaignCategoryÎ°ú Î≥ÄÌôò
        if (category == null || category.isEmpty()) {
            category = "ALL"; // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
        }

        // CampaignSortTypeÏúºÎ°ú Î≥ÄÌôò

        List<CampaignResponse.CampaignListDto> campaignResponseDtoList = campaignQueryService.findAllCampaigns(
                keyword,
                category,
                statusFlag,
                sortType,
                null
        );

        Map<String, Object> resMap = Map.of(
                "campaigns", campaignResponseDtoList,
                "totalElements", campaignResponseDtoList.size()
        );

        return ResponseEntity.ok(resMap);
    }

    @PostMapping(value = "")
    public ApiResponse<?> addCampaign(
            @RequestPart(value = "request", name = "request") @Valid CampaignRequestDto.JoinDto request,
            @RequestPart(value = "image") MultipartFile image,
            @AuthenticationPrincipal CustomUserDetails userDetails
    ) throws IOException {

        if (userDetails == null) {
            throw new CampaignHandler(ErrorStatus._UNAUTHORIZED);
        } else if (!userDetails.isOrganization()) {
            throw new CampaignHandler(ErrorStatus._FORBIDDEN);
        }
        String email = userDetails.getUsername();

        request.setImageUrl("default.png");
        Campaign campaign = campaignCommandService.addCampaign(request, email);

        String imagePath = ImageStore.storeImage(image, "\\campaigns\\" + campaign.getCId() + "\\detail\\");
        campaign.setCImageUrl(imagePath);

        campaign = campaignCommandService.updateCampaign(campaign);

        List<CampaignPlanRequestDto.JoinDto> campaignPlans = request.getPlans();

        campaignPlanCommandService.addCampaignPlan(campaignPlans, campaign);

        // ÏÉà Ï∫†ÌéòÏù∏ ÏïåÎ¶º Ï†ÑÏÜ°
        try {
            OrganizationUser organizationUser = campaign.getOrganizationUser();
            if (organizationUser != null) {

                // üî• Ïù¥ Ï§ÑÎì§ÏùÑ Ï∂îÍ∞Ä
                log.info("=== ÎîîÎ≤ÑÍπÖ ÏãúÏûë ===");
                log.info("Îã®Ï≤¥Î™Ö: " + organizationUser.getOName());
                log.info("Ï∫†ÌéòÏù∏Î™Ö: " + campaign.getCName());
                log.info("=================");


                notificationService.sendNewCampaignNotifications(
                        organizationUser.getOId(),          // Îã®Ï≤¥ ID
                        campaign.getCId(),                 // Ï∫†ÌéòÏù∏ ID
                        campaign.getCName(),               // Ï∫†ÌéòÏù∏ Ïù¥Î¶Ñ
                        organizationUser.getOName()        // Îã®Ï≤¥ Ïù¥Î¶Ñ
                );

                log.info("ÏïåÎ¶º Ï†ÑÏÜ° ÏôÑÎ£å!"); // üî• Ï∂îÍ∞Ä
                log.info("ÏÉà Ï∫†ÌéòÏù∏ ÏïåÎ¶º Ï†ÑÏÜ° ÏôÑÎ£å: {} ({})", campaign.getCName(), campaign.getCId());
            } else{
                log.info("organizationUserÍ∞Ä nullÏûÖÎãàÎã§!"); // üî• Ï∂îÍ∞Ä
            }
        } catch (Exception e) {
            log.error("ÏÉà Ï∫†ÌéòÏù∏ ÏïåÎ¶º Ï†ÑÏÜ° Ïã§Ìå®: {}", campaign.getCName(), e);
            System.out.println("ÏïåÎ¶º Ï†ÑÏÜ° Ïã§Ìå®: " + e.getMessage()); // üî• Ï∂îÍ∞Ä
            // ÏïåÎ¶º Ïã§Ìå®Ìï¥ÎèÑ Ï∫†ÌéòÏù∏ ÏÉùÏÑ±ÏùÄ ÏÑ±Í≥µÏúºÎ°ú Ï≤òÎ¶¨
        }

        return ApiResponse.onSuccess(CampaignConverter.toJoinResult(campaign));
    }

    @GetMapping("{cId}")
    public ApiResponse<?> getCampaign(@PathVariable(value = "cId") Long cId) {
        Campaign campaign = campaignQueryService.findBycId(cId);
        if (campaign == null) {
            throw new CampaignHandler(ErrorStatus.CAMPAIGN_NOT_FOUND);
        }

        OrganizationResponse.OrganizationDetailDto organizationDto = null;

        if (campaign.getOrganizationUser() != null) {
            organizationDto = organizationUserQueryService.convertToDetailDto(campaign.getOrganizationUser());
        }

        return ApiResponse.onSuccess(CampaignConverter.toCampaignDetailDto(
                campaign,
                organizationDto,
                campaignPlansQueryService.getCampaignPlanDetails(cId),
                campaignSpendingQueryService.getCampaignSpending(cId)
        ));
    }

    @GetMapping("{cId}/comments")
    public ApiResponse<?> getCampaignComments(
            @AuthenticationPrincipal CustomUserDetails userDetails,
            @PathVariable(value = "cId") Long cId,
            @RequestParam(value = "page", defaultValue = "0") int page,
            @RequestParam(value = "size", defaultValue = "10") int size) {

        String userEmail = null;

        if (userDetails != null && userDetails.isStudent()) {
            userEmail = userDetails.getUsername();
            System.out.println("User Email: " + userEmail);
        }

        if (page < 0) {
            throw new CampaignHandler(ErrorStatus.PAGE_NUMBER_INVALID);
        }
        if (size <= 0) {
            throw new CampaignHandler(ErrorStatus.PAGE_SIZE_INVALID);
        }

        Pageable pageable = PageRequest.of(page, size);

        return ApiResponse.onSuccess(campaignCommentQueryService.findCommentByCampaignId(cId, pageable, userEmail));
    }

    @PostMapping("{cId}/comments")
    public ApiResponse<?> addCampaignComment(
            @PathVariable(value = "cId") Long cId,
            @RequestBody CampaignCommentRequestDto campaignCommentRequestDto,
            @AuthenticationPrincipal CustomUserDetails userDetails
    ) {
        // Ï∫†ÌéòÏù∏ ÎåìÍ∏Ä Ï∂îÍ∞Ä Î°úÏßÅ
        if (userDetails == null) {
            throw new CampaignHandler(ErrorStatus._UNAUTHORIZED);
        }

        if (!userDetails.isStudent()) {
            throw new CampaignHandler(ErrorStatus._FORBIDDEN);
        }

        String email = userDetails.getUsername();

        CampaignComment newComment = campaignCommentCommandService.addComment(
                campaignCommentRequestDto.getContent(),
                cId,
                email
        );

        return ApiResponse.onSuccess(
                Map.of(
                        "commentId", newComment.getCcId(),
                        "content", newComment.getCcContent(),
                        "createdAt", newComment.getCreatedAt()
                )
        );
    }

    @PostMapping("{cId}/comments/{ccId}/likes")
    public ApiResponse<?> addCommentLike(
            @PathVariable(value = "ccId") Long ccId,
            @AuthenticationPrincipal CustomUserDetails userDetails
    ) {
        if (userDetails == null) {
            throw new CampaignHandler(ErrorStatus._UNAUTHORIZED);
        }

        if (!userDetails.isStudent()) {
            throw new CampaignHandler(ErrorStatus._FORBIDDEN);
        }

        String email = userDetails.getUsername();

        CampaignCommentLike campaignCommentLike = campaignCommentLikeService.toggleCommentLike(ccId, email);

        return ApiResponse.onSuccess(CampaignCommentLikeConverter.toDto(campaignCommentLike));

    }

    @PostMapping(value = "/{cId}/updates", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ApiResponse<?> addCampaignUpdate(
            @ExistCampaign @PathVariable(value = "cId") Long cId,
            @RequestPart(value = "request", name = "request") @Valid CampaignUpdateRequestDto.JoinDto request,
            @RequestPart(value = "image") MultipartFile image,
            @AuthenticationPrincipal CustomUserDetails userDetails
    ) throws IOException {
        Campaign campaign = campaignQueryService.findBycId(cId);

        if (userDetails == null) {
            throw new CampaignHandler(ErrorStatus._UNAUTHORIZED);
        } else if (!userDetails.isOrganization() ||
                !campaign.getOrganizationUser().getOEmail().equals(userDetails.getUsername())) {
            throw new CampaignHandler(ErrorStatus._FORBIDDEN);
        }

        if (campaign.getCStatusFlag() != CampaignStatusFlag.COMPLETED) {
            throw new CampaignHandler(ErrorStatus.CAMPAIGN_NOT_COMPLETED);
        }

        String imagePath = ImageStore.storeImage(image, "\\campaigns\\" + cId + "\\updates\\");

        CampaignUpdate campaignUpdate = campaignUpdateCommandService.addCampaignUpdate(request, imagePath, cId);

        List<CampaignSpendingRequestDto.JoinDto> campaignSpendings = request.getSpendings();

        campaignSpendingCommandService.addCampaignPlan(campaignSpendings, campaign);

        return ApiResponse.onSuccess(CampaignUpdateConverter.toJoinResultDto(campaignUpdate));
    }

    @PatchMapping("/{cId}/status")
    public ApiResponse<?> updateCampaignStatus(
            @ExistCampaign @PathVariable(value = "cId") Long cId,
            @RequestBody @Valid CampaignRequestDto.UpdateStatusDto request,
            @AuthenticationPrincipal CustomUserDetails userDetails
    ) {
        Campaign campaign = campaignQueryService.findBycId(cId);

        if (userDetails == null) {
            throw new CampaignHandler(ErrorStatus._UNAUTHORIZED);
        } else if (!userDetails.isOrganization() ||
                !campaign.getOrganizationUser().getOEmail().equals(userDetails.getUsername())) {
            throw new CampaignHandler(ErrorStatus._FORBIDDEN);
        }

        // üî• Í∏∞Ï°¥ ÏÉÅÌÉú Ï†ÄÏû•
        CampaignStatusFlag oldStatus = campaign.getCStatusFlag();

        campaignCommandService.updateStatusByUser(campaign, request.getStatus());

        // üî• Ï∫†ÌéòÏù∏ ÏôÑÎ£å Ïãú ÏïåÎ¶º Ï†ÑÏÜ°
        try {
            if (oldStatus != CampaignStatusFlag.COMPLETED &&
                    campaign.getCStatusFlag() == CampaignStatusFlag.COMPLETED) {

                OrganizationUser organizationUser = campaign.getOrganizationUser();
                if (organizationUser != null) {
                    notificationService.sendCampaignCompletedNotifications(
                            organizationUser.getOId(),
                            campaign.getCId(),
                            campaign.getCName(),
                            organizationUser.getOName()
                    );
                    log.info("Ï∫†ÌéòÏù∏ ÏôÑÎ£å ÏïåÎ¶º Ï†ÑÏÜ° ÏôÑÎ£å: {} ({})", campaign.getCName(), campaign.getCId());
                }
            }
        } catch (Exception e) {
            log.error("Ï∫†ÌéòÏù∏ ÏôÑÎ£å ÏïåÎ¶º Ï†ÑÏÜ° Ïã§Ìå®: {}", campaign.getCName(), e);
            // ÏïåÎ¶º Ïã§Ìå®Ìï¥ÎèÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏Îäî ÏÑ±Í≥µÏúºÎ°ú Ï≤òÎ¶¨
        }

        return ApiResponse.onSuccess(CampaignConverter.toJoinResult(campaign));
    }
}